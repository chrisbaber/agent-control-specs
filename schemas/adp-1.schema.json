{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://agentcontrollayer.com/schemas/adp-1.schema.json",
  "title": "ADP-1 Agent Run Schema",
  "description": "JSON Schema for Agent Data Protocol (ADP-1) Agent Run records",
  "type": "object",
  "required": ["version", "run_id", "tenant_id", "agent", "steps", "status", "started_at", "completed_at"],
  "properties": {
    "version": {
      "type": "string",
      "const": "adp-1",
      "description": "Protocol version identifier"
    },
    "run_id": {
      "type": "string",
      "format": "uuid",
      "description": "Globally unique identifier for this run"
    },
    "tenant_id": {
      "type": "string",
      "description": "Logical tenant/customer identifier"
    },
    "trace": {
      "type": "object",
      "description": "Distributed tracing context",
      "properties": {
        "trace_id": { "type": "string" },
        "span_id": { "type": "string" },
        "parent_span_id": { "type": "string" }
      }
    },
    "agent": {
      "type": "object",
      "required": ["agent_id", "aip"],
      "properties": {
        "agent_id": {
          "type": "string",
          "description": "Stable logical agent identifier"
        },
        "agent_version": { "type": "string" },
        "framework": {
          "type": "string",
          "description": "Agent framework (e.g., acl, langchain, crew-ai)"
        },
        "framework_run_id": { "type": "string" },
        "aip": {
          "type": "object",
          "required": ["cert_fingerprint"],
          "properties": {
            "cert_fingerprint": {
              "type": "string",
              "description": "SHA-256 fingerprint of the AIP-1 certificate"
            },
            "tenant_id": { "type": "string" },
            "capabilities": {
              "type": "array",
              "items": { "type": "string" },
              "description": "CTX-1 capability strings"
            }
          }
        }
      }
    },
    "context": {
      "type": "object",
      "properties": {
        "task_description": { "type": "string" },
        "workflow_key": { "type": "string" },
        "user_id": { "type": "string" },
        "session_id": { "type": "string" },
        "labels": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "steps": {
      "type": "array",
      "items": { "$ref": "#/$defs/AgentStep" },
      "description": "Array of agent steps"
    },
    "final_output": {
      "type": "object",
      "properties": {
        "type": { "type": "string" },
        "content": { "type": "string" },
        "format": { "type": "string" }
      }
    },
    "status": {
      "type": "string",
      "enum": ["succeeded", "failed", "cancelled", "timeout"],
      "description": "Final status of the run"
    },
    "error": {
      "type": ["object", "null"],
      "description": "Structured error if status != succeeded"
    },
    "cancellation": {
      "type": ["object", "null"],
      "description": "Cancellation info when status = cancelled"
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 start timestamp"
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 completion timestamp"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "total_tokens": { "type": "integer" },
        "total_cost_usd": { "type": "number" },
        "models_used": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    }
  },
  "$defs": {
    "AgentStep": {
      "type": "object",
      "required": ["index", "timestamp", "action", "observation"],
      "properties": {
        "index": {
          "type": "integer",
          "minimum": 0,
          "description": "Zero-based step index"
        },
        "parent_step_index": {
          "type": ["integer", "null"],
          "description": "Index of parent step for hierarchical workflows"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "action": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["tool_call", "message", "plan_update", "model_inference", "other"]
            },
            "name": { "type": "string" },
            "input": { "type": "object" }
          }
        },
        "observation": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["tool_result", "environment", "user_input", "error", "none"]
            },
            "output": { "type": "object" },
            "error": { "type": ["object", "null"] }
          }
        },
        "reflection": {
          "type": "object",
          "properties": {
            "thought": { "type": "string" },
            "next_action_hint": { "type": "string" },
            "uncertainty": {
              "type": "number",
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "metadata": { "type": "object" }
      }
    }
  }
}
